---
# tasks file for terminal_applications

- name: Ensure .local/bin exists
  file:
    path: "{{ ansible_user_dir }}/.local/bin"
    state: directory
    mode: '0755'

- name: Update apt cache and install prerequisites
  apt:
    name:
      - build-essential
      - python3-pip
      - golang
      - software-properties-common
      - curl
      - git
    state: present
    update_cache: yes
  become: yes

- name: Remove old nodesource repository file
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/deb_nodesource_com_node_20_x.list
    state: absent
  become: yes

- name: Download nodesource apt key
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /tmp/nodesource.gpg

- name: Dearmor nodesource apt key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/nodesource.gpg /tmp/nodesource.gpg
    creates: /usr/share/keyrings/nodesource.gpg
  become: yes

- name: Add nodesource apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main"
    state: present
  become: yes

- name: Install nodejs
  apt:
    name: nodejs
    state: present
    update_cache: yes
  become: yes

- name: Download 1Password APT key
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/keys/1password.asc
    dest: /tmp/1password.asc

- name: Dearmor 1Password APT key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/1password-archive-keyring.gpg /tmp/1password.asc
    creates: /usr/share/keyrings/1password-archive-keyring.gpg
  become: yes

- name: Add 1Password APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main"
    state: present
  become: yes

- name: Ensure debsig policy directory exists for 1Password
  ansible.builtin.file:
    path: /etc/debsig/policies/AC2D62742012EA22/
    state: directory
    mode: '0755'
  become: yes

- name: Add debsig-verify policy for 1Password
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/debian/debsig/1password.pol
    dest: /etc/debsig/policies/AC2D62742012EA22/1password.pol
    mode: '0644'
  become: yes

- name: Ensure debsig keyring directory exists for 1Password
  ansible.builtin.file:
    path: /usr/share/debsig/keyrings/AC2D62742012EA22
    state: directory
    mode: '0755'
  become: yes

- name: Add debsig keyring for 1Password
  ansible.builtin.command:
    cmd: gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg /tmp/1password.asc
    creates: /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
  become: yes

- name: Download Kubernetes APT key
  ansible.builtin.get_url:
    url: https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key
    dest: /tmp/kubernetes.key.asc

- name: Dearmor Kubernetes APT key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/kubernetes-archive-keyring.gpg /tmp/kubernetes.key.asc
    creates: /usr/share/keyrings/kubernetes-archive-keyring.gpg
  become: yes

- name: Add Kubernetes APT repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /"
    state: present
  become: yes

- name: Download Helm APT key
  ansible.builtin.get_url:
    url: https://packages.buildkite.com/helm-linux/helm-debian/gpgkey
    dest: /tmp/helm.asc

- name: Dearmor Helm APT key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/helm.gpg /tmp/helm.asc
    creates: /usr/share/keyrings/helm.gpg
  become: yes

- name: Add Helm APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main"
    state: present
  become: yes

- name: Check if rustup is installed
  stat:
    path: "{{ ansible_user_dir }}/.cargo/bin/rustup"
  register: rustup_stat
  become: no

- name: Install Rust (rustup)
  shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  when: not rustup_stat.stat.exists
  args:
    creates: "{{ ansible_user_dir }}/.cargo/bin/rustc"
  become: no

- name: Update Rust
  command: "{{ ansible_user_dir }}/.cargo/bin/rustup update"
  when: rustup_stat.stat.exists
  become: no

- name: Add cargo to PATH for subsequent tasks
  set_fact:
    ansible_env:
      PATH: "{{ ansible_user_dir }}/.cargo/bin:{{ ansible_env.PATH }}"
  become: no

- name: Install lazygit
  shell: |
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | \grep -Po '"tag_name": *"v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    install lazygit -D -t /usr/local/bin/
  args:
    creates: /usr/local/bin/lazygit
  become: yes

- name: Install lazydocker
  shell: |
    LAZYDOCKER_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazydocker/releases/latest" | \grep -Po '"tag_name": *"v\K[^"]*')
    curl -Lo lazydocker.tar.gz "https://github.com/jesseduffield/lazydocker/releases/download/v${LAZYDOCKER_VERSION}/lazydocker_${LAZYDOCKER_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazydocker.tar.gz lazydocker
    install lazydocker -D -t /usr/local/bin/
  args:
    creates: /usr/local/bin/lazydocker
  become: yes

- name: Install k9s
  shell: |
    K9S_VERSION=$(curl -s "https://api.github.com/repos/derailed/k9s/releases/latest" | \grep -Po '"tag_name": *"v\K[^"]*')
    curl -Lo k9s.tar.gz "https://github.com/derailed/k9s/releases/download/v${K9S_VERSION}/k9s_Linux_amd64.tar.gz"
    tar xf k9s.tar.gz k9s
    install k9s -D -t /usr/local/bin/
  args:
    creates: /usr/local/bin/k9s
  become: yes

- name: Download pandoc .deb
  ansible.builtin.get_url:
    url: "{{ pandoc_deb_url }}"
    dest: "{{ pandoc_deb_dest }}"
    mode: '0644'
  become: yes
  when: install_pandoc | bool

- name: Install pandoc from .deb
  ansible.builtin.apt:
    deb: "{{ pandoc_deb_dest }}"
    state: present
  become: yes
  when: install_pandoc | bool

- name: Download Google Cloud public signing key
  ansible.builtin.get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /tmp/google-cloud.gpg
  when: install_gcloud | bool

- name: Dearmor Google Cloud public signing key
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg /tmp/google-cloud.gpg
    creates: /usr/share/keyrings/cloud.google.gpg
  become: yes
  when: install_gcloud | bool

- name: Add Google Cloud SDK APT repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
    state: present
    filename: google-cloud-sdk
  become: yes
  when: install_gcloud | bool

- name: Install Google Cloud CLI and components
  ansible.builtin.apt:
    name:
      - google-cloud-cli
      - google-cloud-cli-gke-gcloud-auth-plugin
    state: present
    update_cache: yes
  become: yes
  when: install_gcloud | bool

- name: Install applications with apt
  apt:
    name: "{{ item.name | default(item) }}"
    state: present
  loop: "{{ applications_apt }}"
  loop_control:
    label: "{{ item.name | default(item) }}"
  become: yes

- name: Create symlinks for apt packages
  file:
    src: "/usr/bin/{{ item.symlink }}"
    dest: "{{ ansible_user_dir }}/.local/bin/{{ item.symlink_name }}"
    state: link
  loop: "{{ applications_apt }}"
  when: item.symlink is defined
  loop_control:
    label: "symlink for {{ item.name | default(item) }}"

- name: Install applications with cargo
  command: >
    {{ ansible_user_dir }}/.cargo/bin/cargo install 
    {{ item.name | default(item) }}
    {{ item.args | default('') }}
  args:
    creates: "{{ ansible_user_dir }}/.cargo/bin/{{ item.binary_name | default(item.name | default(item)) }}"
  loop: "{{ applications_cargo }}"
  loop_control:
    label: "{{ item.name | default(item) }}"
  become: no

- name: Install applications with pip
  pip:
    name: "{{ item }}"
    extra_args: --break-system-packages
  loop: "{{ applications_pip }}"
  loop_control:
    label: "{{ item }}"

- name: Install applications with npm
  npm:
    name: "{{ item }}"
    global: yes
  loop: "{{ applications_npm }}"
  loop_control:
    label: "{{ item }}"
  become: yes

- name: Set Go environment variables
  set_fact:
    gopath: "{{ ansible_user_dir }}/go"
    go_bin: "{{ ansible_user_dir }}/go/bin"

- name: Add go to PATH for subsequent tasks
  set_fact:
    ansible_env:
      PATH: "{{ go_bin }}:{{ ansible_env.PATH }}"

- name: Create go directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ gopath }}"
    - "{{ go_bin }}"

- name: Install applications with go
  command: go install {{ item.name }}
  args:
    creates: "{{ go_bin }}/{{ item.binary_name }}"
  loop: "{{ applications_go }}"
  loop_control:
    label: "{{ item.name }}"
  environment:
    GOPATH: "{{ gopath }}"

- name: Install applications with scripts
  shell: "curl -sSfL {{ item.url }} | {{ item.installer | default('sh') }} {{ item.args | default('') }}"
  args:
    creates: "{{ ansible_user_dir }}/.local/bin/{{ item.name }}"
  loop: "{{ applications_script }}"
  environment:
    CI: "true"
  loop_control:
    label: "{{ item.name }}"

- name: Clone fzf repository
  git:
    repo: 'https://github.com/junegunn/fzf.git'
    dest: "{{ ansible_user_dir }}/.fzf"
    depth: 1
    update: yes
  become: no

- name: Install fzf binary
  command: "{{ ansible_user_dir }}/.fzf/install --bin"
  args:
    creates: "{{ ansible_user_dir }}/.fzf/bin/fzf"
  become: no

- name: Symlink fzf binary to local bin
  file:
    src: "{{ ansible_user_dir }}/.fzf/bin/fzf"
    dest: "{{ ansible_user_dir }}/.local/bin/fzf"
    state: link
  become: no

- name: Add fzf shell integration to .bashrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: "{{ item }}"
    state: present
  loop:
    - 'source "{{ ansible_user_dir }}/.fzf/shell/completion.bash"'
    - 'source "{{ ansible_user_dir }}/.fzf/shell/key-bindings.bash"'

- name: Clean up old shell integration from .bashrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: "{{ item }}"
    state: absent
  loop:
    - 'eval $(thefuck --alias)'
    - 'eval "$(zoxide init bash)"'
    - 'eval "$(zoxide init bash --cmd cd)"'
    - 'eval "$(starship init bash)"'
    - 'eval "$(atuin init bash)"'

- name: Ensure .local/bin is in PATH in .bashrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    state: present
    create: yes

- name: Add shell integration to .bashrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: "{{ item }}"
    create: yes
  loop:
    - 'eval "$(zoxide init bash)"'
    - 'eval "$(starship init bash)"'
    - 'eval "$(atuin init bash)"'

- name: Add aliases to .bashrc
  lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: "alias {{ item.name }}='{{ item.value }}'"
    state: present
  loop:
    - { name: 'l', value: 'lsd -l' }
    - { name: 'la', value: 'lsd -a' }
    - { name: 'lla', value: 'lsd -la' }
    - { name: 'lt', value: 'lsd --tree' }
    - { name: 'ls', value: 'lsd' }

